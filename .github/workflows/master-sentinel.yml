name: Continuous Bug Bounty Scanner Pro

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  dispatch_scans:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Load Targets & Dispatch Scans
        id: dispatch
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸŽ¯ Loading targets from bug_bounty_targets.txt..."

          if [ ! -f "bug_bounty_targets.txt" ]; then
            echo "âŒ bug_bounty_targets.txt not found!"
            echo "dispatched=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TARGETS=$(grep -v '^#' bug_bounty_targets.txt | grep -v '^$' | head -50 || true)
          if [ -z "$TARGETS" ]; then
            echo "No valid targets found."
            echo "dispatched=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          SCAN_ID=$(date +%s)
          DISPATCHED=0

          while IFS= read -r target; do
            if [ -n "$target" ]; then
              echo "ðŸš€ Dispatching scan for: $target"
              curl -s -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                https://api.github.com/repos/${{ github.repository }}/dispatches \
                -d "{
                  \"event_type\": \"scan_target\",
                  \"client_payload\": {
                    \"target\": \"$target\",
                    \"intensity\": \"2\",
                    \"ai_analysis\": \"true\",
                    \"notification_mode\": \"all\",
                    \"scan_id\": \"${SCAN_ID}_${DISPATCHED}\"
                  }
                }" >/dev/null 2>&1
              DISPATCHED=$((DISPATCHED + 1))
              sleep 3
            fi
          done <<< "$TARGETS"

          echo "âœ… Dispatched $DISPATCHED scans"
          echo "dispatched=$DISPATCHED" >> "$GITHUB_OUTPUT"

      - name: Send Summary to Discord
        if: always()
        shell: bash
        run: |
          DISPATCHED="${{ steps.dispatch.outputs.dispatched }}"
          if [ -z "$DISPATCHED" ]; then
            DISPATCHED="0"
          fi
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          cat > discord.json <<EOF
{
  "embeds": [{
    "title": "ðŸ”„ Continuous Scan Initiated",
    "description": "Automated bug bounty scanning started",
    "color": 3447003,
    "fields": [
      {"name": "ðŸ“Š Targets Scanned", "value": "$DISPATCHED", "inline": true},
      {"name": "â° Started", "value": "$TIMESTAMP", "inline": true},
      {"name": "âš¡ Intensity", "value": "Level 2", "inline": true},
      {"name": "ðŸ¤– AI Analysis", "value": "Enabled", "inline": true},
      {"name": "ðŸ”” Notifications", "value": "All Results", "inline": true},
      {"name": "â±ï¸ Next Scan", "value": "In 6 hours", "inline": true}
    ],
    "footer": {"text": "Continuous Bug Bounty Scanner"}
  }]
}
EOF

          curl -s -H "Content-Type: application/json" \
            -d @discord.json \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" >/dev/null 2>&1 || true

          echo "âœ… Discord summary sent."
