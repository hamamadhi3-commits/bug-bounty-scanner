name: üîÑ Continuous Bug Bounty Scanner Pro

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  dispatch_scans:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üéØ Load Targets & Dispatch Scans
        id: dispatch
        shell: bash
        run: |
          set -euo pipefail

          echo "üéØ Loading targets from bug_bounty_targets.txt..."

          if [ ! -f "bug_bounty_targets.txt" ]; then
            echo "‚ùå bug_bounty_targets.txt not found!"
            echo "dispatched=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Read targets (skip comments and empty lines)
          TARGETS=$(grep -v '^#' bug_bounty_targets.txt | grep -v '^$' | head -50 || true)

          if [ -z "$TARGETS" ]; then
            echo "‚ö†Ô∏è No targets found in bug_bounty_targets.txt"
            echo "dispatched=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TARGET_COUNT=$(printf "%s\n" "$TARGETS" | wc -l)
          echo "üìä Found $TARGET_COUNT targets to scan"

          SCAN_ID=$(date +%s)
          DISPATCHED=0

          # Dispatch scans for each target
          while IFS= read -r target; do
            if [ -n "$target" ]; then
              echo "üöÄ Dispatching scan for: $target"

              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/${{ github.repository }}/dispatches" \
                -d "{
                  \"event_type\": \"scan_target\",
                  \"client_payload\": {
                    \"target\": \"$target\",
                    \"intensity\": \"2\",
                    \"ai_analysis\": \"true\",
                    \"notification_mode\": \"all\",
                    \"scan_id\": \"${SCAN_ID}_${DISPATCHED}\"
                  }
                }")

              if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
                DISPATCHED=$((DISPATCHED + 1))
              else
                echo "‚ö†Ô∏è Failed to dispatch $target (HTTP $HTTP_CODE)"
              fi

              sleep 5
            fi
          done <<< "$TARGETS"

          echo "‚úÖ Dispatched $DISPATCHED scans"
          echo "dispatched=$DISPATCHED" >> "$GITHUB_OUTPUT"

      - name: üì§ Send Summary to Discord
        if: always()
        shell: bash
        run: |
          DISPATCHED="${{ steps.dispatch.outputs.dispatched }}"
          if [ -z "$DISPATCHED" ]; then
            DISPATCHED="0"
          fi

          cat > discord_summary.json <<EOF
{
  "embeds": [{
    "title": "üîÑ Continuous Scan Initiated",
    "description": "**Automated bug bounty scanning started**",
    "color": 3447003,
    "fields": [
      {"name": "üìä Targets Scanned", "value": "$DISPATCHED", "inline": true},
      {"name": "‚è∞ Started", "value": "$(date -u +%Y-%m-%dT%H:%M:%SZ)", "inline": true},
      {"name": "‚ö° Intensity", "value": "Level 2", "inline": true},
      {"name": "ü§ñ AI Analysis", "value": "Enabled", "inline": true},
      {"name": "üîî Notifications", "value": "All Results", "inline": true},
      {"name": "‚è±Ô∏è Next Scan", "value": "In 6 hours", "inline": true}
    ],
    "footer": {"text": "Continuous Bug Bounty Scanner"}
  }]
}
EOF

          curl -H "Content-Type: application/json" \
            -d @discord_summary.json \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" || true

          echo "‚úÖ Summary sent to Discord"
