name: ðŸ”„ Continuous Bug Bounty Scanner

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      targets_file:
        description: 'Targets file (default: bug_bounty_targets.txt)'
        required: false
        default: 'bug_bounty_targets.txt'
        type: string
      intensity:
        description: 'Scan intensity (1-3)'
        required: false
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      targets: ${{ steps.load.outputs.targets }}
      count: ${{ steps.load.outputs.count }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ“‹ Load Targets
        id: load
        run: |
          TARGETS_FILE="${{ github.event.inputs.targets_file || 'bug_bounty_targets.txt' }}"
          
          if [ ! -f "$TARGETS_FILE" ]; then
            echo "âš ï¸ Targets file not found, using defaults"
            echo "testphp.vulnweb.com" > targets_temp.txt
            echo "demo.testfire.net" >> targets_temp.txt
            TARGETS_FILE="targets_temp.txt"
          fi
          
          # Remove comments and empty lines
          grep -v '^#' "$TARGETS_FILE" | grep -v '^$' | sort -u > clean_targets.txt || touch clean_targets.txt
          
          if [ ! -s clean_targets.txt ]; then
            echo "âš ï¸ No valid targets found"
            echo "testphp.vulnweb.com" > clean_targets.txt
          fi
          
          TARGETS=$(cat clean_targets.txt | jq -R -s -c 'split("\n") | map(select(length > 0))')
          COUNT=$(cat clean_targets.txt | wc -l)
          
          echo "targets=$TARGETS" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          
          echo "âœ… Loaded $COUNT targets"
          cat clean_targets.txt
  
  scan:
    needs: prepare
    runs-on: ubuntu-latest
    if: needs.prepare.outputs.count > 0
    strategy:
      max-parallel: 3
      matrix:
        target: ${{ fromJson(needs.prepare.outputs.targets) }}
    
    steps:
      - name: ðŸš€ Trigger Worker Scan
        run: |
          TARGET="${{ matrix.target }}"
          INTENSITY="${{ github.event.inputs.intensity || '2' }}"
          
          echo "ðŸŽ¯ Triggering scan for: $TARGET"
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -d "{
              \"event_type\": \"scan_target\",
              \"client_payload\": {
                \"target\": \"$TARGET\",
                \"intensity\": \"$INTENSITY\",
                \"enable_ai\": \"true\",
                \"notification_mode\": \"vulnerabilities_only\"
              }
            }"
          
          echo "âœ… Scan triggered for $TARGET"
          
          # Wait between scans to avoid overwhelming
          sleep 30
  
  summary:
    needs: [prepare, scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ðŸ“Š Send Summary
        run: |
          COUNT="${{ needs.prepare.outputs.count }}"
          
          curl -H "Content-Type: application/json" \
               -d '{
                 "embeds": [{
                   "title": "ðŸ”„ Continuous Scan Cycle Complete",
                   "description": "**Targets Scanned:** '"$COUNT"'\n**Time:** '"$(date -u '+%Y-%m-%d %H:%M:%S UTC')"'\n**Next Scan:** In 6 hours",
                   "color": 5763719,
                   "footer": {"text": "Continuous Bug Bounty Scanner"},
                   "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
                 }]
               }' "${{ secrets.DISCORD_WEBHOOK_URL }}" 2>/dev/null || true
