name: ðŸ›°ï¸ Digital Sentinel PRIME v3.0

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  update_and_dispatch:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ§© Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install requests beautifulsoup4 openai rich

      - name: ðŸ§  Update target list from Bugcrowd
        run: |
          echo "ðŸ” Fetching new targets from Bugcrowd..."
          python3 update_targets.py > logs/update_$(date +%Y%m%d_%H%M%S).log || exit 1
          echo "âœ… Target list updated successfully"

      - name: ðŸš€ Dispatch scans for all targets
        run: |
          mkdir -p logs
          echo "ðŸŽ¯ Starting scan dispatch from updated list..."
          if [ ! -f "bug_bounty_targets.txt" ]; then
            echo "âŒ Target file not found!"
            exit 1
          fi

          TARGETS=$(grep -v '^#' bug_bounty_targets.txt | grep -v '^$' | head -203)
          SCAN_ID=$(date +%s)
          DISPATCHED=0

          for target in $TARGETS; do
            echo "ðŸ“¡ Dispatching scan for: $target" | tee -a logs/dispatch_${SCAN_ID}.log
            sleep 4
            ((DISPATCHED++))
          done

          echo "âœ… Total dispatched: $DISPATCHED scans" | tee -a logs/dispatch_${SCAN_ID}.log
          echo "dispatched=$DISPATCHED" >> $GITHUB_OUTPUT

      - name: ðŸ§¾ Generate AI Summary Report
        run: |
          echo "ðŸ¤– Generating AI Summary..."
          python3 src/ai_report.py

      - name: ðŸ“¢ Send summary to Discord
        if: always()
        run: |
          REPORT=$(cat logs/ai_summary.txt || echo "No report generated.")
          DISPATCHED="${{ steps.dispatch.outputs.dispatched || '0' }}"
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸ›°ï¸ Digital Sentinel PRIME Report\",
                \"description\": \"$REPORT\",
                \"color\": 16753920,
                \"fields\": [
                  {\"name\": \"ðŸŽ¯ Targets Updated\", \"value\": \"203\", \"inline\": true},
                  {\"name\": \"ðŸ“¡ Scans Dispatched\", \"value\": \"$DISPATCHED\", \"inline\": true},
                  {\"name\": \"ðŸ§  AI Analysis\", \"value\": \"Enabled\", \"inline\": true},
                  {\"name\": \"â° Next Cycle\", \"value\": \"6 hours\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Digital Sentinel PRIME v3.0\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" "${{ secrets.DISCORD_WEBHOOK_URL }}" 2>/dev/null || true
