name: Continuous Bug Bounty Scanner Pro

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  dispatch_scans:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Load Targets & Dispatch Scans
        id: dispatch
        shell: bash
        run: |
          set -euo pipefail
          echo "Loading targets from bug_bounty_targets.txt..."

          if [ ! -f "bug_bounty_targets.txt" ]; then
            echo "No target file found!"
            echo "dispatched=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TARGETS=$(grep -v '^#' bug_bounty_targets.txt | grep -v '^$' | head -50 || true)

          if [ -z "$TARGETS" ]; then
            echo "No valid targets found."
            echo "dispatched=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          SCAN_ID=$(date +%s)
          DISPATCHED=0

          while IFS= read -r target; do
            if [ -n "$target" ]; then
              echo "Dispatching: $target"
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/${{ github.repository }}/dispatches" \
                -d "{
                  \"event_type\": \"scan_target\",
                  \"client_payload\": {
                    \"target\": \"$target\",
                    \"intensity\": \"2\",
                    \"ai_analysis\": \"true\",
                    \"notification_mode\": \"all\",
                    \"scan_id\": \"${SCAN_ID}_${DISPATCHED}\"
                  }
                }")

              if [[ "$HTTP_CODE" == 2* ]]; then
                DISPATCHED=$((DISPATCHED + 1))
              else
                echo "Failed to dispatch ($HTTP_CODE)"
              fi

              sleep 5
            fi
          done <<< "$TARGETS"

          echo "Dispatched $DISPATCHED scans"
          echo "dispatched=$DISPATCHED" >> "$GITHUB_OUTPUT"

      - name: Send Summary to Discord
        if: always()
        shell: bash
        run: |
          DISPATCHED="${{ steps.dispatch.outputs.dispatched }}"
          [ -z "$DISPATCHED" ] && DISPATCHED="0"

          cat > discord.json <<EOF
{
  "embeds": [{
    "title": "Continuous Scan Initiated",
    "description": "Automated bug bounty scanning started",
    "color": 3447003,
    "fields": [
      {"name": "Targets Scanned", "value": "$DISPATCHED", "inline": true},
      {"name": "Started", "value": "$(date -u +%Y-%m-%dT%H:%M:%SZ)", "inline": true},
      {"name": "Intensity", "value": "Level 2", "inline": true},
      {"name": "AI Analysis", "value": "Enabled", "inline": true},
      {"name": "Notifications", "value": "All Results", "inline": true},
      {"name": "Next Scan", "value": "In 6 hours", "inline": true}
    ]
  }]
}
EOF

          curl -H "Content-Type: application/json" \
            -d @discord.json \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" || true

          echo "Discord summary sent."
