name: ðŸ”„ Continuous Bug Bounty Scanner PRIME

on:
  schedule:
    - cron: '0 */6 * * *'  # run every 6 hours
  workflow_dispatch:

jobs:
  update_and_dispatch:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§  Update target list from Bugcrowd
        run: |
          echo "ðŸ” Fetching new targets from Bugcrowd..."
          python3 update_targets.py || exit 1
          echo "âœ… Target list updated successfully"

      - name: ðŸ“Š Preview top targets
        run: |
          echo "Top 10 targets fetched:"
          head -10 bug_bounty_targets.txt || echo "No targets found!"

      - name: ðŸš€ Dispatch scans for all targets
        run: |
          echo "ðŸŽ¯ Starting scan dispatch from updated list..."
          if [ ! -f "bug_bounty_targets.txt" ]; then
            echo "âŒ Target file not found!"
            exit 1
          fi

          TARGETS=$(grep -v '^#' bug_bounty_targets.txt | grep -v '^$' | head -203)
          TARGET_COUNT=$(echo "$TARGETS" | wc -l)
          SCAN_ID=$(date +%s)
          DISPATCHED=0

          for target in $TARGETS; do
            echo "ðŸ“¡ Dispatching scan for: $target"
            curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/${{ github.repository }}/dispatches \
              -d "{
                \"event_type\": \"scan_target\",
                \"client_payload\": {
                  \"target\": \"$target\",
                  \"intensity\": \"2\",
                  \"ai_analysis\": \"true\",
                  \"notification_mode\": \"all\",
                  \"scan_id\": \"${SCAN_ID}_${DISPATCHED}\"
                }
              }" 2>/dev/null
            ((DISPATCHED++))
            sleep 4
          done

          echo "âœ… Total dispatched: $DISPATCHED scans"
          echo "dispatched=$DISPATCHED" >> $GITHUB_OUTPUT

      - name: ðŸ“¢ Send summary to Discord
        if: always()
        run: |
          DISPATCHED="${{ steps.dispatch.outputs.dispatched || '0' }}"
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ðŸš€ Digital Sentinel PRIME Scan Initiated\",
                \"description\": \"Automated scan launched after target update from Bugcrowd\",
                \"color\": 5763719,
                \"fields\": [
                  {\"name\": \"ðŸŽ¯ Targets Updated\", \"value\": \"203\", \"inline\": true},
                  {\"name\": \"ðŸ“¡ Scans Dispatched\", \"value\": \"$DISPATCHED\", \"inline\": true},
                  {\"name\": \"ðŸ§  AI Analysis\", \"value\": \"Enabled\", \"inline\": true},
                  {\"name\": \"â° Next Cycle\", \"value\": \"6 hours\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Digital Sentinel PRIME\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" "${{ secrets.DISCORD_WEBHOOK_URL }}" 2>/dev/null || true
