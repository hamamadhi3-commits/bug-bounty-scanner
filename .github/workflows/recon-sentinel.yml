name: ğŸŒ Recon Sentinel Engine v5.0 â€“ Autonomous Mode

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # run every 6 hours automatically

jobs:
  recon:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install requests beautifulsoup4 aiohttp

      - name: ğŸš€ Run Scope Fetcher
        run: |
          echo "ğŸš€ Fetching scopes from Bugcrowd..."
          python3 src/scope_fetcher.py

      - name: ğŸ” Run Recon Engine
        run: |
          echo "ğŸ” Running parallel recon scan..."
          python3 src/recon_engine.py

      - name: â™»ï¸ Auto Scope Updater
        run: |
          echo "â™»ï¸ Auto-updating scopes..."
          python3 src/auto_scope_updater.py

      - name: ğŸ“£ Notify Discord
        if: always()
        run: |
          curl -H "Content-Type: application/json" \
          -d "{\"content\": \"âœ… Recon Sentinel v5.0 cycle completed successfully (Digital Sentinel Autonomous Mode).\"}" \
          "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: â™»ï¸ Re-trigger Self Run
        if: always()
        run: |
          echo "â™»ï¸ Re-triggering Recon Sentinel workflow..."
          curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/recon-sentinel.yml/dispatches \
          -d '{"ref":"main"}'

      - name: ğŸ” Trigger Worker Sentinel
        if: always()
        run: |
          echo "ğŸš€ Triggering Worker Sentinel v4.2..."
          curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/worker-sentinel.yml/dispatches \
          -d '{"ref":"main"}'

      - name: ğŸ§  Trigger Digital Sentinel PRIME
        if: always()
        run: |
          echo "ğŸ§  Triggering Digital Sentinel PRIME v4.1..."
          curl -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/actions/workflows/master-sentinel.yml/dispatches \
          -d '{"ref":"main"}'
