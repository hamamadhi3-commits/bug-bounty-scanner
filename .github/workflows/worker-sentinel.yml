name: Worker Sentinel Stable

on:
  repository_dispatch:
    types: [scan_target]

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load target
        id: target
        run: |
          echo "target=${{ github.event.client_payload.target }}" >> $GITHUB_OUTPUT
          echo "scan_id=${{ github.event.client_payload.scan_id }}" >> $GITHUB_OUTPUT

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y sqlmap jq
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          go install github.com/projectdiscovery/naabu/v2/cmd/naabu@latest

      - name: Subdomains
        run: |
          subfinder -d "${{ steps.target.outputs.target }}" -silent -o subs.txt || true

      - name: Live hosts
        run: |
          [ -s subs.txt ] && httpx -list subs.txt -silent -o live.txt || touch live.txt

      - name: URLs
        run: |
          if [ -s live.txt ]; then
            cat live.txt | katana -silent -o urls.txt || true
          else
            touch urls.txt
          fi

      - name: Nuclei scan
        id: nuclei
        run: |
          if [ -s live.txt ]; then
            nuclei -list live.txt -silent -jsonl -o nuclei.json || true
          else
            touch nuclei.json
          fi
          echo "count=$(wc -l < nuclei.json || echo 0)" >> $GITHUB_OUTPUT

      - name: Simple Discord summary
        if: always()
        run: |
          TARGET="${{ steps.target.outputs.target }}"
          NCOUNT="${{ steps.nuclei.outputs.count }}"

          echo "{\"content\": \"Scan completed for $TARGET â€” Found $NCOUNT vulnerabilities\"}" > body.json

          curl \
            -H "Content-Type: application/json" \
            -d @body.json \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "scan-${{ steps.target.outputs.scan_id }}"
          path: |
            subs.txt
            live.txt
            urls.txt
            nuclei.json
