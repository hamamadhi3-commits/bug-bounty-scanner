name: ğŸ§  Worker Sentinel Stable

on:
  repository_dispatch:
    types: [scan_target]

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¯ Load target payload
        id: payload
        run: |
          echo "target=${{ github.event.client_payload.target }}" >> $GITHUB_OUTPUT
          echo "scan_id=${{ github.event.client_payload.scan_id }}" >> $GITHUB_OUTPUT
          echo "intensity=${{ github.event.client_payload.intensity }}" >> $GITHUB_OUTPUT
          echo "ai_analysis=${{ github.event.client_payload.ai_analysis }}" >> $GITHUB_OUTPUT
          echo "notification_mode=${{ github.event.client_payload.notification_mode }}" >> $GITHUB_OUTPUT

      - name: âš™ï¸ Install scanning tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq sqlmap
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest

      - name: ğŸŒ Enumerate Subdomains
        run: |
          subfinder -d "${{ steps.payload.outputs.target }}" -silent -o subs.txt || true

      - name: ğŸ” Check Live Hosts
        run: |
          [ -s subs.txt ] && httpx -list subs.txt -silent -o live.txt || touch live.txt

      - name: ğŸ•·ï¸ Crawl URLs
        run: |
          if [ -s live.txt ]; then
            cat live.txt | katana -silent -o urls.txt || true
          else
            touch urls.txt
          fi

      - name: ğŸš¨ Vulnerability Scanning
        run: |
          if [ -s live.txt ]; then
            nuclei -list live.txt -silent -jsonl -o nuclei.json || true
          else
            touch nuclei.json
          fi
          echo "vulns=$(wc -l < nuclei.json || echo 0)" >> $GITHUB_OUTPUT

      - name: ğŸ¤– AI Analysis (optional)
        if: ${{ steps.payload.outputs.ai_analysis == 'true' }}
        run: |
          echo "ğŸ§  AI analyzing results..."
          echo "AI Summary for ${{ steps.payload.outputs.target }}" > ai_summary.txt
          echo "Total vulnerabilities: $(wc -l < nuclei.json)" >> ai_summary.txt
          echo "Completed at $(date -u)" >> ai_summary.txt

      - name: ğŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "scan-${{ steps.payload.outputs.scan_id }}"
          path: |
            subs.txt
            live.txt
            urls.txt
            nuclei.json
            ai_summary.txt

      - name: ğŸ“¡ Send Discord Report
        if: always()
        run: |
          TARGET="${{ steps.payload.outputs.target }}"
          COUNT=$(wc -l < nuclei.json || echo 0)
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ğŸ§  Worker Sentinel Scan Complete\",
                \"description\": \"Scan completed for **$TARGET**\",
                \"color\": 3447003,
                \"fields\": [
                  {\"name\": \"ğŸš¨ Vulnerabilities\", \"value\": \"$COUNT\", \"inline\": true},
                  {\"name\": \"âš™ï¸ Intensity\", \"value\": \"${{ steps.payload.outputs.intensity }}\", \"inline\": true},
                  {\"name\": \"ğŸ¤– AI Analysis\", \"value\": \"${{ steps.payload.outputs.ai_analysis }}\", \"inline\": true},
                  {\"name\": \"ğŸ•’ Completed\", \"value\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"Worker Sentinel Stable\"}
              }]
            }" "${{ secrets.DISCORD_WEBHOOK_URL }}"
