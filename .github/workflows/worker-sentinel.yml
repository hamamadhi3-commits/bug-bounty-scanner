name: ðŸ”¥ Worker Sentinel ULTIMATE Pro

on:
  repository_dispatch:
    types: [scan_target]

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Load Target
        id: target
        run: |
          echo "target=${{ github.event.client_payload.target }}" >> $GITHUB_OUTPUT
          echo "intensity=${{ github.event.client_payload.intensity }}" >> $GITHUB_OUTPUT
          echo "ai_analysis=${{ github.event.client_payload.ai_analysis }}" >> $GITHUB_OUTPUT
          echo "notification_mode=${{ github.event.client_payload.notification_mode }}" >> $GITHUB_OUTPUT
          echo "scan_id=${{ github.event.client_payload.scan_id }}" >> $GITHUB_OUTPUT

      - name: ðŸ”§ Install Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y sqlmap jq
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          go install github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
          go install github.com/hahwul/dalfox/v2@latest
          go install github.com/ffuf/ffuf/v2@latest
          go install github.com/tomnomnom/waybackurls@latest
          go install github.com/lc/gau/v2/cmd/gau@latest
          go install github.com/003random/getJS@latest

      - name: ðŸ” Subdomain Discovery
        run: |
          TARGET="${{ steps.target.outputs.target }}"
          subfinder -d "$TARGET" -all -silent -o subs.txt || true

      - name: ðŸ”Œ Port Scanner
        run: |
          if [ -s subs.txt ]; then
            naabu -list subs.txt -top-ports 100 -silent -o ports.txt || true
          else
            touch ports.txt
          fi

      - name: ðŸŒ Probe Live Hosts
        run: |
          if [ -s subs.txt ]; then
            httpx -list subs.txt -silent -o live.txt || true
          else
            touch live.txt
          fi

      - name: ðŸ•·ï¸ Crawl Websites
        run: |
          if [ -s live.txt ]; then
            cat live.txt | katana -silent -o urls.txt || true
            cat live.txt | waybackurls >> urls.txt || true
            cat live.txt | gau >> urls.txt || true
            sort -u urls.txt -o urls.txt
          else
            touch urls.txt
          fi

      - name: ðŸ”Ž Nuclei Scan
        id: nuclei
        run: |
          if [ -s live.txt ]; then
            nuclei -list live.txt -silent -jsonl -o nuclei.json || true
          else
            touch nuclei.json
          fi
          COUNT=$(wc -l < nuclei.json || echo 0)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: ðŸ’‰ SQL Injection Testing
        id: sqli
        run: |
          SQLI=0
          if [ -s urls.txt ]; then
            grep '?' urls.txt | head -20 > params.txt || true
            while read -r u; do
              timeout 30 sqlmap -u "$u" --batch --level=1 &>/dev/null && SQLI=$((SQLI+1))
            done < params.txt
          fi
          echo "count=$SQLI" >> $GITHUB_OUTPUT

      - name: âš¡ XSS Detection
        id: xss
        run: |
          if [ -s urls.txt ]; then
            grep '?' urls.txt | dalfox pipe -silent -o xss.txt || true
            XSS=$(wc -l < xss.txt || echo 0)
          else
            XSS=0
          fi
          echo "count=$XSS" >> $GITHUB_OUTPUT

      - name: ðŸ¤– Discord Reporting
        if: always()
        run: |
          SUBS=$(wc -l < subs.txt || echo 0)
          LIVE=$(wc -l < live.txt || echo 0)
          URLS=$(wc -l < urls.txt || echo 0)
          VULN="${{ steps.nuclei.outputs.count }}"
          SQLI="${{ steps.sqli.outputs.count }}"
          XSS="${{ steps.xss.outputs.count }}"
          TOTAL=$((VULN + SQLI + XSS))

          cat > summary.json <<EOF
{
  "content": "ðŸ“Š Scan Complete!",
  "embeds": [{
    "title": "ðŸ”¥ Worker Sentinel Scan Result",
    "color": 5814783,
    "fields": [
      {"name": "ðŸŽ¯ Target", "value": "${{ steps.target.outputs.target }}"},
      {"name": "ðŸŒ Subdomains", "value": "$SUBS"},
      {"name": "ðŸŸ¢ Live Hosts", "value": "$LIVE"},
      {"name": "ðŸ•· URLs", "value": "$URLS"},
      {"name": "ðŸ› Nuclei", "value": "$VULN"},
      {"name": "ðŸ’‰ SQLi", "value": "$SQLI"},
      {"name": "âš¡ XSS", "value": "$XSS"},
      {"name": "ðŸš¨ Total", "value": "$TOTAL"}
    ]
  }]
}
EOF

          curl -H "Content-Type: application/json" \
               -d @summary.json \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: ðŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-${{ steps.target.outputs.scan_id }}
          path: |
            subs.txt
            live.txt
            urls.txt
            nuclei.json
            xss.txt
            ports.txt
