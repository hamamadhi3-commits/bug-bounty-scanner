name: "Worker Sentinel Ultimate Pro"

on:
  repository_dispatch:
    types: [scan_target]

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Load Target
        id: target
        run: |
          echo "target=${{ github.event.client_payload.target }}" >> $GITHUB_OUTPUT
          echo "intensity=${{ github.event.client_payload.intensity }}" >> $GITHUB_OUTPUT
          echo "ai_analysis=${{ github.event.client_payload.ai_analysis }}" >> $GITHUB_OUTPUT
          echo "notification_mode=${{ github.event.client_payload.notification_mode }}" >> $GITHUB_OUTPUT
          echo "scan_id=${{ github.event.client_payload.scan_id }}" >> $GITHUB_OUTPUT

      - name: Install Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y sqlmap jq
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          go install github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
          go install github.com/hahwul/dalfox/v2@latest
          go install github.com/ffuf/ffuf/v2@latest
          go install github.com/tomnomnom/waybackurls@latest
          go install github.com/lc/gau/v2/cmd/gau@latest
          go install github.com/003random/getJS@latest

      - name: Subdomain Discovery
        run: |
          TARGET="${{ steps.target.outputs.target }}"
          subfinder -d "$TARGET" -silent -o subs.txt || true

      - name: Port Scanner
        run: |
          [ -s subs.txt ] && naabu -list subs.txt -top-ports 100 -silent -o ports.txt || touch ports.txt

      - name: Probe Live Hosts
        run: |
          [ -s subs.txt ] && httpx -list subs.txt -silent -o live.txt || touch live.txt

      - name: Crawl URLs
        run: |
          if [ -s live.txt ]; then
            cat live.txt | katana -silent -o urls.txt || true
            cat live.txt | waybackurls >> urls.txt || true
            cat live.txt | gau >> urls.txt || true
            sort -u urls.txt -o urls.txt
          else
            touch urls.txt
          fi

      - name: Nuclei Scan
        id: nuclei
        run: |
          if [ -s live.txt ]; then
            nuclei -list live.txt -silent -jsonl -o nuclei.json || true
          else
            touch nuclei.json
          fi
          COUNT=$(wc -l < nuclei.json || echo 0)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: SQL Injection Testing
        id: sqli
        run: |
          SQLI=0
          if [ -s urls.txt ]; then
            grep '?' urls.txt | head -20 > params.txt || true
            while read -r url; do
              timeout 30 sqlmap -u "$url" --batch &>/dev/null && SQLI=$((SQLI+1))
            done < params.txt
          fi
          echo "count=$SQLI" >> $GITHUB_OUTPUT

      - name: XSS Detection
        id: xss
        run: |
          if [ -s urls.txt ]; then
            grep '?' urls.txt | dalfox pipe -silent -o xss.txt || true
            XSS=$(wc -l < xss.txt || echo 0)
          else
            XSS=0
          fi
          echo "count=$XSS" >> $GITHUB_OUTPUT

      - name: Discord Report
        if: always()
        run: |
          SUBS=$(wc -l < subs.txt || echo 0)
          LIVE=$(wc -l < live.txt || echo 0)
          URLS=$(wc -l < urls.txt || echo 0)
          VULN=${{ steps.nuclei.outputs.count }}
          SQLI=${{ steps.sqli.outputs.count }}
          XSS=${{ steps.xss.outputs.count }}
          TOTAL=$((VULN + SQLI + XSS))

          cat > report.json <<EOF
{
  "embeds": [{
    "title": "Scan Complete",
    "color": 5814783,
    "fields": [
      {"name": "Target", "value": "${{ steps.target.outputs.target }}"},
      {"name": "Subdomains", "value": "$SUBS"},
      {"name": "Live Hosts", "value": "$LIVE"},
      {"name": "URLs", "value": "$URLS"},
      {"name": "Nuclei", "value": "$VULN"},
      {"name": "SQLi", "value": "$SQLI"},
      {"name": "XSS", "value": "$XSS"},
      {"name": "Total", "value": "$TOTAL"}
    ]
  }]
}
EOF

          curl -H "Content-Type: application/json" \
               -d @report.json \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-${{ steps.target.outputs.scan_id }}
          path: |
            subs.txt
            live.txt
            urls.txt
            nuclei.json
            ports.txt
            xss.txt
